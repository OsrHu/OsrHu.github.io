<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>os3 | 微笑紫瞳星</title><meta name="keywords" content="os"><meta name="author" content="Osrhu"><meta name="copyright" content="Osrhu"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="osCPU学习">
<meta property="og:type" content="article">
<meta property="og:title" content="os3">
<meta property="og:url" content="https://osrhu.xyz/os/os3/index.html">
<meta property="og:site_name" content="微笑紫瞳星">
<meta property="og:description" content="osCPU学习">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.osrhu.xyz/images/cover/os.png">
<meta property="article:published_time" content="2021-12-19T08:55:04.000Z">
<meta property="article:modified_time" content="2021-12-19T09:02:41.119Z">
<meta property="article:author" content="Osrhu">
<meta property="article:tag" content="os">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.osrhu.xyz/images/cover/os.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://osrhu.xyz/os/os3/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'os3',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: false,
  postUpdate: '2021-12-19 17:02:41'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/background.css"><link rel="stylesheet" href="/css/universe.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sviptzk/HexoStaticFile@master/Hexo/css/hideCategory.min.css"><meta name="generator" content="Hexo 5.4.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://cdn.osrhu.xyz/2.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">5</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">2</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.osrhu.xyz/images/cover/os.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">微笑紫瞳星</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">os3</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-12-19T08:55:04.000Z" title="发表于 2021-12-19 16:55:04">2021-12-19</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-12-19T09:02:41.119Z" title="更新于 2021-12-19 17:02:41">2021-12-19</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/os/">os</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">2.8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>9分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="os3"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout hide-aside" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h1><h2 id="工作模式"><a href="#工作模式" class="headerlink" title="工作模式"></a>工作模式</h2><p>实模式、保护模式、长模式（主要是因为X86 CPU的历史包袱，为了向下兼容，让老的程序仍然可以在新的CPU上执行。）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">    int* addr = (int*)0;</span><br><span class="line">    cli(); //关中断</span><br><span class="line">    while(1)</span><br><span class="line">    &#123;</span><br><span class="line">        *addr = 0;</span><br><span class="line">        addr++;</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在实模式下，这段代码可以运行。实模式下，没有现代操作系统的概念。</p>
<p>第一，CPU 对任何指令不加区分地执行；</p>
<p>第二，CPU 对访问内存的地址不加限制。</p>
<h2 id="实模式"><a href="#实模式" class="headerlink" title="实模式"></a>实模式</h2><p>实模式又称为实地址模式，实模式的“实”体现在两个方面。一个是指令功能，一个是内存地址。</p>
<p>x86 CPU实模式下的CPU</p>
 <img src="https://cdn.osrhu.xyz/images/os3.assets\image-20211219144614185.png">



 <img src="https://cdn.osrhu.xyz/images/os3.assets\image-20211219151125889.png">

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">data SEGMENT ;定义一个数据段存放Hello World!</span><br><span class="line">    hello  DB &#x27;Hello World!$&#x27; ;注意要以$结束</span><br><span class="line">data ENDS</span><br><span class="line">code SEGMENT ;定义一个代码段存放程序指令</span><br><span class="line">    ASSUME CS:CODE,DS:DATA ;告诉汇编程序，DS指向数据段，CS指向代码段</span><br><span class="line">start:</span><br><span class="line">    MOV AX,data  ;将data段首地址赋值给AX                </span><br><span class="line">    MOV DS,AX    ;将AX赋值给DS，使DS指向data段</span><br><span class="line">    LEA DX,hello ;使DX指向hello首地址</span><br><span class="line">    MOV AH,09h   ;给AH设置参数09H，AH是AX高8位，AL是AX低8位，其它类似</span><br><span class="line">    INT 21h      ;执行DOS中断输出DS指向的DX指向的字符串hello</span><br><span class="line">    MOV AX,4C00h ;给AX设置参数4C00h</span><br><span class="line">    INT 21h      ;调用4C00h号功能，结束程序</span><br><span class="line">code ENDS</span><br><span class="line">END start</span><br></pre></td></tr></table></figure>

<h2 id="实模式中断"><a href="#实模式中断" class="headerlink" title="实模式中断"></a>实模式中断</h2><ul>
<li>中断控制器给CPU发送一个电子信号，CPU会对这个信号做出应答。随后中断控制器会将中断号发送给CPU，这是硬件中断。</li>
<li>CPU执行了INT指令，指令后面会跟随一个常数，这个常数就是软中断号。这称为软件中断。</li>
</ul>
<h2 id="中断向量表"><a href="#中断向量表" class="headerlink" title="中断向量表"></a>中断向量表</h2><p>内存中放一个中断向量表，这个表的地址和长度由 CPU 的特定寄存器 IDTR 指向</p>
 <img src="https://cdn.osrhu.xyz/images/os3.assets\image-20211219152049893.png">

<p>IDTR + 中断号 —&gt; 中断代码段基址、段内偏移</p>
<h2 id="保护模式–对CPU进行抽象虚拟化处理"><a href="#保护模式–对CPU进行抽象虚拟化处理" class="headerlink" title="保护模式–对CPU进行抽象虚拟化处理"></a>保护模式–对CPU进行抽象虚拟化处理</h2><h3 id="保护模式寄存器"><a href="#保护模式寄存器" class="headerlink" title="保护模式寄存器"></a>保护模式寄存器</h3> <img src="https://cdn.osrhu.xyz/images/os3.assets\image-20211219152322519.png">



<h3 id="保护模式特权级"><a href="#保护模式特权级" class="headerlink" title="保护模式特权级"></a>保护模式特权级</h3><p>为了区分哪些指令（如 in、out、cli）和哪些资源（如寄存器、I/O 端口、内存地址）可以被访问，CPU 实现了特权级。</p>
<p>特权级分为 4 级，R0~R3，每个特权级执行指令的数量不同，R0 可以执行所有指令，R1、R2、R3 依次递减，它们只能执行上一级指令数量的子集。而内存的访问则是靠后面所说的段描述符和特权级相互配合去实现的。如下图.</p>
 <img src="https://cdn.osrhu.xyz/images/os3.assets\image-20211219152806855.png">

<h2 id="保护模式段描述符"><a href="#保护模式段描述符" class="headerlink" title="保护模式段描述符"></a>保护模式段描述符</h2> <img src="https://cdn.osrhu.xyz/images/os3.assets\image-20211219153303218.png">

<p>多个段描述符在内存中形成全局段描述符表，该表的基地址和长度由 CPU 和 GDTR 寄存器指示。如下图所示。</p>
 <img src="https://cdn.osrhu.xyz/images/os3.assets\image-20211219153351327.png">



<h2 id="保护模式段选择子"><a href="#保护模式段选择子" class="headerlink" title="保护模式段选择子"></a>保护模式段选择子</h2><p>CS,SS寄存器</p>
 <img src="https://cdn.osrhu.xyz/images/os3.assets\image-20211219153543835.png">

<p>通常情况下，CS 和 SS 中 RPL 就组成了 CPL（当前权限级别），所以常常是 RPL=CPL，进而 CPL 就表示发起访问者要以什么权限去访问目标段，当 CPL 大于目标段 DPL 时，则 CPU 禁止访问，只有 CPL 小于等于目标段 DPL 时才能访问。保护模式平坦模型</p>
<h2 id="保护模式平坦模式"><a href="#保护模式平坦模式" class="headerlink" title="保护模式平坦模式"></a>保护模式平坦模式</h2><p>分段模型有很多缺陷，现代操作系统都会使用分页模型。</p>
<p>CPU 32 位的寄存器最多只能产生 4GB 大小的地址，而一个段长度也只能是 4GB，所以我们把所有段的基地址设为 0，段的长度设为 0xFFFFF，段长度的粒度设为 4KB，这样所有的段都指向同一个（0~4GB-1）字节大小的地址空间</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GDT_START:</span><br><span class="line">knull_dsc: dq 0</span><br><span class="line">;第一个段描述符CPU硬件规定必须为0</span><br><span class="line">kcode_dsc: dq 0x00cf9e000000ffff</span><br><span class="line">;段基地址=0，段长度=0xfffff</span><br><span class="line">;G=1,D/B=1,L=0,AVL=0 </span><br><span class="line">;P=1,DPL=0,S=1</span><br><span class="line">;T=1,C=1,R=1,A=0</span><br><span class="line">kdata_dsc: dq 0x00cf92000000ffff</span><br><span class="line">;段基地址=0，段长度=0xfffff</span><br><span class="line">;G=1,D/B=1,L=0,AVL=0 </span><br><span class="line">;P=1,DPL=0,S=1</span><br><span class="line">;T=0,C=0,R=1,A=0</span><br><span class="line">GDT_END:</span><br><span class="line"></span><br><span class="line">GDT_PTR:</span><br><span class="line">GDTLEN  dw GDT_END-GDT_START-1</span><br><span class="line">GDTBASE  dd GDT_START</span><br></pre></td></tr></table></figure>

<p>段长度需要和 G 位配合，若 G 位为 1 则段长度等于 0xfffff 个 4KB。上面段描述符的 DPL=0，这说明需要最高权限即 CPL=0 才能访问。</p>
<h2 id="保护模式中断"><a href="#保护模式中断" class="headerlink" title="保护模式中断"></a>保护模式中断</h2><p>保护模式下，中断需要做检查跟特权级的切换。因此就需要扩展中断向量表的信息。</p>
<p>每个中断用一个中断门描述符来表示，简称为中断门。</p>
 <img src="https://cdn.osrhu.xyz/images/os3.assets\image-20211219155018402.png">

<p>保护模式要实现中断，也必须在内存中有一个中断向量表，同样是由 IDTR 寄存器指向，只不过中断向量表中的条目变成了中断门描述符，如下图所示。</p>
 <img src="https://cdn.osrhu.xyz/images/os3.assets\image-20211219155113659.png">

<h2 id="切换到保护模式"><a href="#切换到保护模式" class="headerlink" title="切换到保护模式"></a>切换到保护模式</h2><p>x86 CPU 在第一次加电和每次 reset 后，都会自动进入实模式，要想进入保护模式，就需要程序员写代码实现从实模式切换到保护模式。切换到保护模式的步骤如下。</p>
<ol>
<li><p>准备全局段描述符表—-代码段和数据段，基地址0,段长度0xfffff</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GDT_START:</span><br><span class="line">knull_dsc: dq 0</span><br><span class="line">kcode_dsc: dq 0x00cf9e000000ffff</span><br><span class="line">kdata_dsc: dq 0x00cf92000000ffff</span><br><span class="line">GDT_END:</span><br><span class="line">GDT_PTR:</span><br><span class="line">GDTLEN  dw GDT_END-GDT_START-1</span><br><span class="line">GDTBASE  dd GDT_START</span><br></pre></td></tr></table></figure></li>
<li><p>加载设置 GDTR 寄存器，使之指向全局段描述符表。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">lgdt [GDT_PTR]</span><br></pre></td></tr></table></figure></li>
<li><p>设置 CR0 寄存器，开启保护模式</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">;开启 PE</span><br><span class="line">mov eax, cr0</span><br><span class="line">bts eax, 0                      ; CR0.PE =1</span><br><span class="line">mov cr0, eax         </span><br></pre></td></tr></table></figure></li>
<li><p>进行长跳转，加载 CS 段寄存器，即段选择子。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">jmp dword 0x8 :_32bits_mode ;_32bits_mode为32位代码标号即段偏移</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="长模式"><a href="#长模式" class="headerlink" title="长模式"></a>长模式</h2><p>​    长模式又名AMD64</p>
<h2 id="长模式寄存器"><a href="#长模式寄存器" class="headerlink" title="长模式寄存器"></a>长模式寄存器</h2><p>长模式相比于保护模式，增加了一些通用寄存器，并扩展通用寄存器的位宽，所有的通用寄存器都是 64 位，还可以单独使用低 32 位。</p>
 <img src="https://cdn.osrhu.xyz/images/os3.assets\image-20211219160349511.png">

<h2 id="长模式段描述符"><a href="#长模式段描述符" class="headerlink" title="长模式段描述符"></a>长模式段描述符</h2><p>长模式依然具备保护模式绝大多数特性，如特权级和权限检查。</p>
 <img src="https://cdn.osrhu.xyz/images/os3.assets\image-20211219160412754.png">

<p>在长模式下，CPU 不再对段基址和段长度进行检查，只对 DPL 进行相关的检查，这个检查流程和保护模式下一样。当描述符中的 L=1，D/B=0 时，就是 64 位代码段，DPL 还是 0~3 的特权级。然后有多个段描述在内存中形成一个全局段描述符表，同样由 CPU 的 GDTR 寄存器指向。</p>
<p>长模式下的段描述符表:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ex64_GDT:</span><br><span class="line">null_dsc:  dq 0</span><br><span class="line">;第一个段描述符CPU硬件规定必须为0</span><br><span class="line">c64_dsc:dq 0x0020980000000000  ;64位代码段</span><br><span class="line">;无效位填0</span><br><span class="line">;D/B=0,L=1,AVL=0 </span><br><span class="line">;P=1,DPL=0,S=1</span><br><span class="line">;T=1,C=0,R=0,A=0</span><br><span class="line">d64_dsc:dq 0x0000920000000000  ;64位数据段</span><br><span class="line">;无效位填0</span><br><span class="line">;P=1,DPL=0,S=1</span><br><span class="line">;T=0,C/E=0,R/W=1,A=0</span><br><span class="line">eGdtLen   equ $ - null_dsc  ;GDT长度</span><br><span class="line">eGdtPtr:dw eGdtLen - 1  ;GDT界限</span><br><span class="line">     dq ex64_GDT</span><br></pre></td></tr></table></figure>

<h2 id="长模式下的中断门描述符的格式"><a href="#长模式下的中断门描述符的格式" class="headerlink" title="长模式下的中断门描述符的格式"></a>长模式下的中断门描述符的格式</h2> <img src="https://cdn.osrhu.xyz/images/os3.assets\image-20211219161048011.png">

<p>长模式弱化段模式管理，只保留了权限级别的检查，忽略了段基址和段长度，而地址的检查则交给了 MMU。</p>
<p>​        在没有使用的虚拟内存管理（Virtual Memory Management）技术机器上，虚拟地址被直接送到内存总线上，使具有相同地址的物理存储器被读写。而在使用了虚拟存储器的情况下，虚拟地址不是被直接送到内存地址总线上，而是送到内存管理单元MMU。他由一个或一组芯片组成，一般存在与协处理器中，其功能是把虚拟地址映射为物理地址。</p>
<p>下面这张图就是描述虚拟地址/物理地址和CPU核、MMU、内存之间的关系。</p>
 <img src="https://cdn.osrhu.xyz/images/os3.assets\image-20211219162201393.png">

<p>参考：<a target="_blank" rel="noopener" href="https://nieyong.github.io/wiki_cpu/CPU%E4%BD%93%E7%B3%BB%E6%9E%B6%E6%9E%84-MMU.html">https://nieyong.github.io/wiki_cpu/CPU%E4%BD%93%E7%B3%BB%E6%9E%B6%E6%9E%84-MMU.html</a></p>
<hr>
<p>实模式，保护模式，长模式，逐渐演进</p>
<p>1、实模式：<br>(1)代码段地址+左移4位+ IP = 取指<br>数据段+左移4位+ 通用寄存器值 = 数据地址<br>栈段SS+左移4位 + SP = 栈地址<br>(2)实模式中断：<br>中断号+ IDTR 寄存器(指向中断表的地址和长度) —&gt; 根据中断号，找到中断表中的对应条目 —&gt; 解析出中断函数基地址填充CS、中断函数偏移填充IP —&gt; 响应中断。</p>
<p>2、保护模式：<br>(1)保护模式寄存器：通用寄存器，IP，SP 16位-&gt;32位。添加了EFLAGS cpu标志寄存器和几个cpu控制寄存器。 CS DS SS 中改为存放内存段的索引，用于寻找内存中的段描述符。<br>(2)保护模式下，R0 – R3的特权级别访问。通过内存中存放64位段描述符实现特权划分，段地址寻址。<br> CS | DS | SS （段描述符索引）+ GDTR（指向全局段描述符表基地址） – &gt; 找到段描述符 –&gt; 解析代码段还是数据段，地址，访问权限<br> 其中影子寄存器 : 通过硬件实现，是段描述符的高速缓存, 防止反复读内存，提高效率。<br> 权限问题：当前执行程序的CS RPL、SS RPL = CPL, 要访问的段描述符中拿到DPL， CPL &gt; DPL 禁止程序访问目标段， CPL &lt;= DPL , 可以访问<br>(3)保护模式的平坦模型: 段基址为0，段长度为4G的特殊段管理模式，规避历史原因导致的分段模型缺陷。<br>(4)保护模式中断:中断号+ IDTR 寄存器(指向中断表) —&gt; 根据中断号，找到中断表指向的内存中的中断门描述符 —&gt; 中断门和中断描述符中段选择子的权限检查–&gt; 中断门描述符中目标代码段选择子填充CS， 目标代码段偏移填充EIP —&gt; 响应中断。<br>权限问题：当前CPL小于等于中断门DPL，才可进中断门，当前CPL，大于段选择子的DPL，则设置CPL=段选择子DPL。<br>例：当前运行代码CPL=R3级别，遇R3中断门进门，执行特权级中断程序R0，此时CRL=R0。</p>
<p>(5) 切换保护模式： 准备全局描述附表GDT，<br>GDTR指向GDT，<br>设置CR0开启保护模式，<br>执行长跳转,CPU根据8索引值索引GDT中第二条数据，加载CS</p>
<p>3、长模式：<br>（1）寄存器扩展到64位<br>（2）长模式段描述符, L=1，D/B=0 时是64 位代码段， L ， D/B, 无效是数据段<br>（3）长模式中断：中断们描述符比保护模式多了8字节64位，用于存放64位的目标代码段偏移多出来的高32位。<br>其他中断过程同保护模式。<br>（4）长模式切换：准备长模式全局段描述符表,<br>准备长模式下的MMU页表,开启分页模式<br>CR3指向页表物理地址<br>GDTR指向全局段描述符表<br>IA32_EFER寄存器第8位开启长模式，CR0寄存器= 0x31开启保护模式和分页模式<br>进行跳转，索引GDT， 加载 CS 段寄存器，刷新其影子寄存器</p>
<p>（5）长模式弱化段模式管理，只保留了权限级别的检查，忽略了段基址和段长度，而地址的检查则交给了 MMU，分页管理。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Osrhu</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://osrhu.xyz/os/os3/">https://osrhu.xyz/os/os3/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://osrhu.xyz" target="_blank">微笑紫瞳星</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/os/">os</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.osrhu.xyz/images/cover/os.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/os/os2/"><img class="next-cover" src="https://cdn.osrhu.xyz/images/cover/os.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">os2</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/os/os1/" title="os1"><img class="cover" src="https://cdn.osrhu.xyz/images/cover/os.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-19</div><div class="title">os1</div></div></a></div><div><a href="/os/os2/" title="os2"><img class="cover" src="https://cdn.osrhu.xyz/images/cover/os.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-19</div><div class="title">os2</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021  <i id="heartbeat" class="fa fas fa-heartbeat"></i> Osrhu</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a><br>
<img src="https://cdn.osrhu.xyz/12.png">
<a href="https://beian.miit.gov.cn/"  style="color:#f72b07" target="_blank">浙ICP备2021038272号-1</a></div><div class="footer_custom_text">Hi, welcome to my blog!</div></div><head><<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/HCLonely/images@master/others/heartbeat.min.css"></head></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '8PWdI2xxLVxO1q1WUDgU7wiQ-gzGzoHsz',
      appKey: 'jJusLElgXz7nukreoJ4dnOBF',
      placeholder: 'Please leave your footprints',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'en',
      recordIP: false,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: false,
      path: window.location.pathname,
      requiredFields: ["nick,mail"],
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script defer src="/js/universe.js"></script><script src="/js/background.js"></script><script src="/js/hideCategory.js"></script><canvas id="universe"></canvas><canvas class="fireworks" mobile="true"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/fireworks.min.js"></script><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>